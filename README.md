# Entanglement Calculator

A Node.js TypeScript application that precomputes and analyzes star configurations for Star Battle-style grids to detect "entanglement" patterns.

## Installation

```bash
npm install
```

## Build

```bash
npm run build
```

## Main Program

The main program performs a complete analysis pipeline:

```bash
npm start -- --gridSize=10 --starsPerLine=2 --entangledStars=2 --output=./output/10x10-2star-entanglements.json
```

Or using the compiled version:

```bash
node dist/cli/index.js --gridSize=10 --starsPerLine=2 --entangledStars=2 --output=./output/10x10-2star-entanglements.json
```

### Command Line Options

- `--gridSize <number>`: Grid size (x by x), default: 10
- `--starsPerLine <number>`: Stars per row and column, default: 2
- `--entangledStars <number>`: Initial star count (pattern size), default: 2
- `--output <path>`: Output file path, default: ./output/result.json
- `--includeInherent` or `--includeInherent=true`: Include inherently forced_empty cells in output (adjacent cells and cells on same row/column when all initial stars are on a line), default: false
- `--includeCompatibleSolutions` or `--includeCompatibleSolutions=true`: Include compatible_solutions count in pattern output, default: false

### Processing Steps

The main program performs the following steps:

1. **Enumerate all valid configurations** - Finds all valid Star Battle solutions for the given board size
2. **Generate initial-star patterns** - Creates all valid patterns of the specified star count
3. **Test patterns for entanglement** - Analyzes each pattern using multithreaded workers to find forced cells
4. **Extract pure entanglement geometries** (2-star patterns only) - Groups patterns by canonical star geometry using D4 symmetry
5. **Mine constrained entanglements** (2-star patterns only) - Finds feature-based constraints that separate different forced-empty patterns

For 2-star patterns, the program also automatically saves a `*-solutions.json` file containing all enumerated solutions (needed for triple entanglement mining).

## Standalone Tools

### Extract Pure Entanglements

Extract pure entanglement templates from existing output files:

```bash
node dist/cli/extract-pure-entanglements.js --input=output/10x10-2star-entanglements.json [--output=output.json] [--minOccurrences=2]
```

### Mine Constrained Entanglements

Mine constrained entanglement rules from existing output files:

```bash
node dist/cli/mine-constrained-entanglements.js --input=output/10x10-2star-entanglements.json [--output=output.json] [--minOccurrences=2]
```

### Mine Triple Entanglements

Mine triple entanglement rules (analyzes individual candidate cells):

```bash
node dist/cli/mine-triple-entanglements.js --input=output/10x10-2star-entanglements.json --solutions=output/10x10-2star-entanglements-solutions.json [--output=output.json] [--minOccurrences=2]
```

**Note:** Triple entanglement mining requires the solutions file (`*-solutions.json`) which is automatically generated by the main program for 2-star patterns.

## Features

### Core Features

- Enumerates all valid Star Battle configurations
- Generates and analyzes initial-star patterns
- Multithreaded processing using worker threads
- Progress reporting every second
- User confirmation prompt before starting computation
- Iteration count estimation

### Entanglement Analysis Features

- **Pure Entanglement Extraction**: Groups patterns by canonical star geometry (using D4 symmetry) and identifies geometries that always produce the same forced-empty pattern
- **Constrained Entanglement Mining**: Finds feature-based constraints (edge positions, regions, etc.) that determine when different forced-empty patterns occur for the same star geometry
- **Triple Entanglement Mining**: Analyzes individual candidate cells as triples (star pair + candidate) to determine when specific cells are forced empty vs flexible

### Symmetry and Canonicalization

All entanglement analysis uses D4 symmetry group transformations (8 transforms: identity, reflections, rotations) to canonicalize star geometries. This ensures that geometrically equivalent patterns are grouped together regardless of their position or orientation on the board.

## Output Files

### Main Output (`*-entanglements.json`)

Contains all non-trivial patterns with:
- Board configuration parameters
- Total number of valid solutions
- Array of patterns with:
  - Initial star positions
  - Compatible solution count (optional)
  - Forced empty cells
  - Forced star cells

### Pure Entanglements (`*-pure-entanglements.json`)

Contains canonical star geometries that always produce the same forced-empty pattern:
- `board_size`: Board size
- `initial_stars`: Number of stars in patterns
- `pure_entanglement_templates`: Array of templates with:
  - `canonical_stars`: Normalized star positions
  - `canonical_forced_empty`: Normalized forced empty positions
  - `occurrences`: Number of times this pattern appeared

### Constrained Entanglements (`*-constrained-entanglements.json`)

Contains rules with feature-based constraints:
- `board_size`: Board size
- `initial_stars`: Number of stars in patterns
- `unconstrained_rules`: Rules without constraints (pure entanglements)
- `constrained_rules`: Rules with feature constraints that separate different patterns:
  - `canonical_stars`: Normalized star positions
  - `canonical_forced_empty`: Normalized forced empty positions
  - `constraint_features`: Array of feature names (e.g., `["star0_on_top_edge", "candidate_on_outer_ring"]`)
  - `occurrences`: Number of occurrences

### Triple Entanglements (`*-triple-entanglements.json`)

Contains rules for individual candidate cells:
- `board_size`: Board size
- `initial_stars`: Number of stars in patterns
- `unconstrained_rules`: Rules where candidate is always forced empty
- `constrained_rules`: Rules with constraints that determine when candidate is forced empty:
  - `canonical_stars`: Normalized star positions
  - `canonical_candidate`: Normalized candidate cell position
  - `constraint_features`: Array of feature names
  - `forced`: Always `true` (candidate is forced empty when constraints are met)
  - `occurrences`: Number of occurrences

### Solutions File (`*-solutions.json`)

Contains all enumerated valid configurations as an array of grids (2D arrays of 0s and 1s). This file is required for triple entanglement mining.

## Feature Set

The constraint mining uses the following boolean features:

### Star Position Features
- `star0_on_top_edge`, `star0_on_bottom_edge`, `star0_on_left_edge`, `star0_on_right_edge`
- `star1_on_top_edge`, `star1_on_bottom_edge`, `star1_on_left_edge`, `star1_on_right_edge`
- `min_row_is_0`, `max_row_is_board_size_minus_1`
- `min_col_is_0`, `max_col_is_board_size_minus_1`

### Relative Position Features
- `stars_same_row`, `stars_same_col`
- `both_stars_in_top_half`, `both_stars_in_bottom_half`
- `both_stars_in_left_half`, `both_stars_in_right_half`

### Candidate Cell Features (Triple Mining)
- `candidate_on_top_edge`, `candidate_on_bottom_edge`, `candidate_on_left_edge`, `candidate_on_right_edge`
- `candidate_on_outer_ring` (on any edge)
- `candidate_in_top_left_3x3`, `candidate_in_top_right_3x3`
- `candidate_in_bottom_left_3x3`, `candidate_in_bottom_right_3x3`

## Limitations

- Pure entanglement extraction and constrained/triple mining are currently only supported for 2-star patterns (D4 symmetry canonicalization requires pairs)
- For patterns with more than 2 stars, only the basic pattern analysis is performed

## Development

### Project Structure

The project is organized into the following directories:

```
src/
├── __tests__/          # Test files
│   ├── core/          # Tests for core algorithms
│   ├── miners/        # Tests for mining algorithms
│   └── utils/         # Tests for utility functions
├── cli/                # CLI entry points
│   ├── index.ts                    # Main program
│   ├── test-specific-pattern.ts    # Pattern testing tool
│   ├── extract-pure-entanglements.ts
│   ├── mine-constrained-entanglements.ts
│   └── mine-triple-entanglements.ts
├── core/               # Core algorithms
│   ├── enumeration.ts              # Configuration enumeration
│   └── patternAnalyzer.ts          # Pattern analysis
├── miners/             # Mining algorithms
│   ├── pureEntanglementExtractor.ts
│   ├── constrainedEntanglementMiner.ts
│   └── tripleEntanglementMiner.ts
├── types/               # Type definitions
│   └── index.ts
├── utils/               # Utility functions
│   └── index.ts
└── workers/             # Worker thread code
    └── worker.ts
```

### Running in Development Mode

```bash
npm run dev -- --gridSize=10 --starsPerLine=2 --entangledStars=2
```

### Testing

The project uses [Vitest](https://vitest.dev/) for testing. Run tests with:

```bash
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run tests with coverage report
npm run test:coverage
```

Test files are located in `src/__tests__/` and follow the same directory structure as the source code.

### Testing Specific Patterns

```bash
npm run test:pattern
```

This runs `test-specific-pattern.ts` which allows you to test individual patterns interactively.
